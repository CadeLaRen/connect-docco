<!DOCTYPE html>  <html> <head>   <title>connect-docco.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               connect-docco.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>You probably already know <a href="http://jashkenas.github.com/docco/">Docco</a>. It
produces HTML that displays your comments alongside your code. Comments are
passed through
<a href="http://daringfireball.net/projects/markdown/syntax">Markdown</a>, and code is
passed through <a href="http://pygments.org/">Pygments</a> syntax highlighting. Though,
in thit package, the dependency to Python/Pygments has been removed in favor
of prettiffy syntax highlighter (module embedded in this repo)</p>

<p>docco is designed as a command line tool, and primary for generating
documentation.</p>

<p>The following is a slight variation of docco, designed to be run as a
connect middleware. It allows one to generate docco page upon requests and
respond the docco ouput instead of writing to the filesystem.</p>

<p>Could be a great fit to simply get immediate results of docco against local
files, which happen to be quite handy.</p>

<p>What follows is for the most part coming from docco itself.</p>

<p><strong>New hot stuff</strong>: The socket.io/watchTree combo allow you to
have documentations updated instantly in your browser. You'll
just have to save files, and enjoy the live update...</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h5>fun things starting there</h5>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Setup</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">Path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">),</span>
<span class="nx">Url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">),</span>
<span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">),</span>
<span class="nx">ghm</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;markdown&#39;</span><span class="p">),</span>
<span class="nx">watch</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;watch&#39;</span><span class="p">),</span>
<span class="nx">socketio</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">),</span>
<span class="nx">prettify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../support/prettify&#39;</span><span class="p">),</span>
<span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">,</span>
<span class="nx">send</span><span class="p">,</span> <span class="nx">parse</span><span class="p">,</span> <span class="nx">highlight</span><span class="p">,</span> <span class="nx">escape</span><span class="p">,</span> <span class="nx">pigmentize</span><span class="p">,</span> <span class="nx">fileChanged</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The start of each Pygments highlight block.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">highlight_start</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The end of each Pygments highlight block.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">highlight_end</span> <span class="o">=</span> <span class="s1">&#39;&lt;/pre&gt;&lt;/div&gt;&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Micro-templating, originally by John Resig, borrowed by way of
<a href="http://documentcloud.github.com/underscore/">Underscore.js</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">template</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s1">&#39;obj&#39;</span><span class="p">,</span> <span class="s1">&#39;var p=[],print=function(){p.push.apply(p,arguments);};&#39;</span> <span class="o">+</span> <span class="s1">&#39;with(obj){p.push(\&#39;&#39;</span> <span class="o">+</span> <span class="nx">str</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[\r\t\n]/g</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&#39;(?=[^&lt;]*%&gt;)/g</span><span class="p">,</span> <span class="s2">&quot;\t&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\\&#39;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;\t&quot;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;%=(.+?)%&gt;/g</span><span class="p">,</span> <span class="s2">&quot;&#39;,$1,&#39;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&lt;%&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&#39;);&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;%&gt;&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;p.push(&#39;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;&#39;);}return p.join(&#39;&#39;);&quot;</span><span class="p">);</span>
<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Create the template that we will use to generate the Docco HTML page.
todo: change and use the file in <code>support/docco</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">docco_template</span> <span class="o">=</span> <span class="nx">template</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../support/docco.jst&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()),</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Create the template function that we will use to generate the docco HTML page. This one
just includes the <code>#container</code> content, used to emit back <code>changed</code> event to clients.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">docco_container</span> <span class="o">=</span> <span class="nx">template</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../support/docco/docco.jst&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">()),</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The CSS styles we'd like to apply to the documentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">docco_styles</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../node_modules/docco/resources/docco.css&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The prettify CSS styles we'd like to apply to the documentation.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">prettify_styles</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/../support/prettify.css&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(),</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The request handler for the special <code>docco.css</code> req.url case</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">docco_css</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/css&#39;</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">([</span><span class="nx">docco_styles</span><span class="p">,</span> <span class="nx">prettify_styles</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n\n&#39;</span><span class="p">));</span>
<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>A list of the languages that Docco supports, mapping the file extension to
the name of the Pygments lexer and the symbol that indicates a comment. To
add another language to Docco's repertoire, add it here.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">languages</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;.coffee&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;coffee-script&#39;</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="s1">&#39;#&#39;</span>
  <span class="p">},</span>
  <span class="s1">&#39;.js&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="s1">&#39;//&#39;</span>
  <span class="p">},</span>
  <span class="s1">&#39;.json&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;javascript&#39;</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="s1">&#39;//&#39;</span>
  <span class="p">},</span>
  <span class="s1">&#39;.rb&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;ruby&#39;</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="s1">&#39;#&#39;</span>
  <span class="p">},</span>
  <span class="s1">&#39;.py&#39;</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;python&#39;</span><span class="p">,</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="s1">&#39;#&#39;</span>
  <span class="p">}</span>
<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Get the current language we're documenting, based on the extension.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">get_language</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">get_language</span><span class="p">(</span><span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">languages</span><span class="p">[</span><span class="nx">Path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">source</span><span class="p">)];</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Build out the appropriate matchers and delimiters for each language.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">ext</span> <span class="k">in</span> <span class="nx">languages</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">l</span> <span class="o">=</span> <span class="nx">languages</span><span class="p">[</span><span class="nx">ext</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Does the line begin with a comment?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">l</span><span class="p">.</span><span class="nx">comment_matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;^\\s*&#39;</span> <span class="o">+</span> <span class="nx">l</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s1">&#39;\\s?&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Ignore <a href="http://en.wikipedia.org/wiki/Shebang_(Unix">hashbangs</a>) and interpolations...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">l</span><span class="p">.</span><span class="nx">comment_filter</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(^#![/]|^\\s*#\\{)&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>The dividing token we feed into Pygments, to delimit the boundaries between sections.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">l</span><span class="p">.</span><span class="nx">divider_text</span> <span class="o">=</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">l</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s1">&#39;DIVIDER\n&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>The mirror of <code>divider_text</code> that we expect Pygments to return. We can
split on this to recover the original sections. Note: the class is "c" for
Python and "c1" for the other languages</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">l</span><span class="p">.</span><span class="nx">divider_html</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;\\n*&lt;span class=&quot;c1?&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">l</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">+</span> <span class="s1">&#39;DIVIDER&lt;\\/span&gt;\\n*&#39;</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Middleware</h3>

<p>Create and expose the middleware and request handler.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>root required</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">root</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;root path required&#39;</span><span class="p">);</span>

  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

  <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">app</span><span class="p">,</span>
    <span class="nx">io</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>todo: refactor and move this in its own module</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;An APP! Setup watch/socket.io stuff&#39;</span><span class="p">);</span>

    <span class="nx">io</span> <span class="o">=</span> <span class="nx">socketio</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;create monitor for &#39;</span><span class="p">,</span> <span class="nx">root</span><span class="p">);</span>

    <span class="nx">watch</span><span class="p">.</span><span class="nx">createMonitor</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">monitor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Monitoring &#39;</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">monitor</span><span class="p">.</span><span class="nx">files</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;files&#39;</span><span class="p">);</span>

      <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>todo: far from ideal, attching a new handler on each connection.
We prevent sending the same msg if the last timestamp is same though.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">monitor</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">fileChanged</span><span class="p">.</span><span class="nx">bind</span><span class="p">({},</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">root</span><span class="p">));</span>
        <span class="nx">monitor</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="nx">fileChanged</span><span class="p">.</span><span class="nx">bind</span><span class="p">({},</span> <span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">root</span><span class="p">));</span>
        <span class="nx">monitor</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="nx">fileChanged</span><span class="p">.</span><span class="nx">bind</span><span class="p">({},</span> <span class="s1">&#39;removed&#39;</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">root</span><span class="p">));</span>
      <span class="p">});</span>

    <span class="p">});</span>
  <span class="p">}</span>


  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">root</span><span class="o">:</span> <span class="nx">root</span><span class="p">,</span>
      <span class="nx">path</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Send function, similar to the static middleware send function.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">send</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">send</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;path required&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>setup</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">root</span> <span class="o">?</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">root</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>ignore non-GET requests</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span> <span class="o">!=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">head</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>parse url</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">Url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
    <span class="nx">query</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span>
    <span class="nx">path</span> <span class="o">=</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">pathname</span><span class="p">),</span>
    <span class="nx">type</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>join / normalize from optional root dir</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">path</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">Path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">path</span><span class="p">));</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>if req is docco.css, send it to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/docco\.css/</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">docco_css</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>requested file extension not supported by docco, fallback silently
or does not have a docco parameters (whatever value it has)
wont pass if query docco null/undefined.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">get_language</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="o">||</span> <span class="nx">query</span><span class="p">.</span><span class="nx">docco</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>ignore ENOENT</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;ENOENT&#39;</span> <span class="o">==</span> <span class="nx">err</span><span class="p">.</span><span class="nx">code</span> <span class="o">?</span> <span class="nx">next</span><span class="p">()</span> <span class="o">:</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>ignore directories</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
    <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Generate the documentation for a source file by reading it in, splitting it up into comment/code sections, highlighting them for the appropriate language, and merging them into an HTML template.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">sections</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">highlight</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">sections</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span>
          <span class="nx">html</span> <span class="o">=</span> <span class="nx">docco_template</span><span class="p">({</span>
            <span class="nx">title</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span>
            <span class="nx">sections</span><span class="o">:</span> <span class="nx">sections</span><span class="p">,</span>
            <span class="nx">sources</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">path</span><span class="o">:</span> <span class="nx">path</span><span class="p">,</span>
            <span class="nx">style</span><span class="o">:</span> <span class="nx">docco_styles</span><span class="p">,</span>
            <span class="nx">port</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">app</span> <span class="o">?</span> <span class="nx">options</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span> <span class="s1">&#39;8082&#39;</span>
          <span class="p">});</span>

          <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h3>Generation function</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Given a string of source code, parse out each comment and the code that follows it, and create an individual <strong>section</strong> for it.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">code_text</span><span class="p">,</span> <span class="nx">docs_text</span><span class="p">,</span> <span class="nx">has_code</span><span class="p">,</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">lines</span><span class="p">,</span> <span class="nx">save</span><span class="p">,</span> <span class="nx">sections</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
  <span class="nx">lines</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span>
  <span class="nx">sections</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">language</span> <span class="o">=</span> <span class="nx">get_language</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
  <span class="nx">has_code</span> <span class="o">=</span> <span class="nx">docs_text</span> <span class="o">=</span> <span class="nx">code_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">language</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Wasn&#39;t able to get language for&quot;</span><span class="p">,</span> <span class="nx">source</span><span class="p">);</span>

  <span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
      <span class="nx">docs_text</span><span class="o">:</span> <span class="nx">docs</span><span class="p">,</span>
      <span class="nx">code_text</span><span class="o">:</span> <span class="nx">code</span>
    <span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">lines</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">line</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">comment_matcher</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">line</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">comment_filter</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">has_code</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">save</span><span class="p">(</span><span class="nx">docs_text</span><span class="p">,</span> <span class="nx">code_text</span><span class="p">);</span>
        <span class="nx">has_code</span> <span class="o">=</span> <span class="nx">docs_text</span> <span class="o">=</span> <span class="nx">code_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">docs_text</span> <span class="o">+=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">comment_matcher</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">has_code</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">code_text</span> <span class="o">+=</span> <span class="nx">line</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">save</span><span class="p">(</span><span class="nx">docs_text</span><span class="p">,</span> <span class="nx">code_text</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">sections</span><span class="p">;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Highlights a single chunk of code, using <strong>Prettify</strong> , and runs the text of its corresponding comment through <strong>Markdown</strong>, using the <strong>Github-flavored-Markdown</strong> modification of <a href="http://attacklab.net/showdown/">Showdown.js</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">highlight</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">highlight</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">sections</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">get_language</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">language</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Main processing: for each sections, build according docs<em>html/code</em>html.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">sections</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">section</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">section</span><span class="p">.</span><span class="nx">code_html</span> <span class="o">=</span> <span class="nx">highlight_start</span> <span class="o">+</span> <span class="nx">prettify</span><span class="p">.</span><span class="nx">prettyPrintOne</span><span class="p">(</span><span class="nx">escape</span><span class="p">(</span><span class="nx">section</span><span class="p">.</span><span class="nx">code_text</span><span class="p">))</span> <span class="o">+</span> <span class="nx">highlight_end</span><span class="p">;</span>
    <span class="nx">section</span><span class="p">.</span><span class="nx">docs_html</span> <span class="o">=</span> <span class="nx">ghm</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">section</span><span class="p">.</span><span class="nx">docs_text</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Highlights a single chunk of code, using <strong>Pygments</strong> over stdio, and runs
the text of its corresponding comment through <strong>Markdown</strong>.</p>

<p><strong>Note</strong>: Here for legacy reason, the pygments highlight is better, but less portable.
Not used, in favor of prettify syntax highlight.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pigmentize</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">pigmentize</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">sections</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">language</span><span class="p">,</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">pygments</span><span class="p">,</span> <span class="nx">section</span><span class="p">;</span>
  <span class="nx">language</span> <span class="o">=</span> <span class="nx">get_language</span><span class="p">(</span><span class="nx">source</span><span class="p">);</span>
  <span class="nx">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>requested file extension not supported, fallback silently</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">language</span><span class="p">)</span> <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>

  <span class="nx">pygments</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="s1">&#39;pygmentize&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="nx">language</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;-O&#39;</span><span class="p">,</span> <span class="s1">&#39;encoding=utf-8&#39;</span><span class="p">]);</span>
  <span class="nx">pygments</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">output</span> <span class="o">=</span> <span class="nx">output</span> <span class="o">+</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
  <span class="nx">pygments</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">fragments</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">section</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
    <span class="nx">output</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">highlight_start</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">highlight_end</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">fragments</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">divider_html</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">section</span> <span class="o">=</span> <span class="nx">sections</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">code_html</span> <span class="o">=</span> <span class="nx">highlight_start</span> <span class="o">+</span> <span class="nx">fragments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">highlight_end</span><span class="p">;</span>
      <span class="nx">section</span><span class="p">.</span><span class="nx">docs_html</span> <span class="o">=</span> <span class="nx">ghm</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">section</span><span class="p">.</span><span class="nx">docs_text</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">callback</span><span class="p">();</span>
  <span class="p">});</span>
  <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">write</span><span class="p">(((</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
    <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">sections</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">section</span> <span class="o">=</span> <span class="nx">sections</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
      <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">section</span><span class="p">.</span><span class="nx">code_text</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
  <span class="p">})()).</span><span class="nx">join</span><span class="p">(</span><span class="nx">language</span><span class="p">.</span><span class="nx">divider_text</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">pygments</span><span class="p">.</span><span class="nx">stdin</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>simple escape method, really basic. Escapes <code>&lt;</code>/<code>&gt;</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">escape</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">str</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;lt;&#39;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&gt;/g</span><span class="p">,</span> <span class="s1">&#39;&amp;gt;&#39;</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>fileChanged</h3>

<p>Tree Monitor handler. Called whether a file is created/updated/removed.</p>

<p>Generate the documentation for a source file by reading it in, splitting it up
into comment/code sections, highlighting them for the appropriate language,
and merging them into an HTML template with only <code>#container</code> content.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">fileChanged</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">fileChanged</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">stat</span><span class="p">,</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;File changed. Do doccooooooo!&#39;</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;status: &#39;</span><span class="p">,</span> <span class="nx">status</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">get_language</span><span class="p">(</span><span class="nx">f</span><span class="p">))</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="s1">&#39;not in known language.&#39;</span><span class="p">);</span>

  <span class="nx">Path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="s1">&#39;not there, dont try anything.&#39;</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">exist</span><span class="p">)</span> <span class="k">return</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Well let&#39;s try with some delay&quot;</span><span class="p">);</span>
      <span class="nx">Path</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Here it is or not?&#39;</span><span class="p">,</span> <span class="nx">exist</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">exist</span><span class="p">)</span> <span class="nx">read</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">read</span><span class="p">();</span>


  <span class="kd">function</span> <span class="nx">read</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>

      <span class="kd">var</span> <span class="nx">sections</span> <span class="o">=</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">content</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">highlight</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">sections</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">title</span> <span class="o">=</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">f</span><span class="p">),</span>
          <span class="nx">html</span> <span class="o">=</span> <span class="nx">docco_container</span><span class="p">({</span>
            <span class="nx">title</span><span class="o">:</span> <span class="nx">title</span><span class="p">,</span>
            <span class="nx">sections</span><span class="o">:</span> <span class="nx">sections</span><span class="p">,</span>
            <span class="nx">sources</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">path</span><span class="o">:</span> <span class="nx">f</span><span class="p">,</span>
            <span class="nx">style</span><span class="o">:</span> <span class="nx">docco_styles</span>
          <span class="p">});</span>

          <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;changed&#39;</span><span class="p">,</span> <span class="nx">Path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">f</span><span class="p">),</span> <span class="nx">f</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="nx">html</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 